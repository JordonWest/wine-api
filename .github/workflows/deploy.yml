name: Deploy to EC2 Instance

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:
    inputs:
      environment:
        description: "select deploy environment"
        type: choice
        default: 'test'
        options:
          - test
          - prod
      
jobs:
  deploy:
    runs-on: ubuntu-latest
    if: ${{ inputs.environment }} == "test"
    steps:
      - name: Determine Deploy Env
        run: |
          if [ ${{ inputs.environment }} == "test" ]; then
            echo "DEPLOY_ENV=${{ vars.DEV_INSTANCE }}" >> $GITHUB_ENV
          else
            echo "DEPLOY_ENV=${{ vars.PROD_INSTANCE }}" >> $GITHUB_ENV
          fi
      - name: Checkout the code
        uses: actions/checkout@v1
      - name: get repository name
        run: echo "REPOSITORY_NAME=${GITHUB_REPOSITORY#*/}" >> $GITHUB_ENV
      - name: Deploy to my EC2 instance
        uses: easingthemes/ssh-deploy@v5.0.3
        env:
          SSH_PRIVATE_KEY: ${{ secrets.EC2_SSH_KEY }}
          ARGS: -avzr --delete
          SOURCE: "./"
          REMOTE_HOST: ${{ env.DEPLOY_ENV }}
          REMOTE_USER: "ec2-user"
          TARGET: "/home/ec2-user/${{ env.REPOSITORY_NAME }}"
          SCRIPT_AFTER: |
            cd ~/${{ env.REPOSITORY_NAME }}
            docker-compose down -v
            docker-compose up -d --build
            sleep 5
            docker exec wine-api-api-1 python3 /src/manage.py makemigrations
            docker exec wine-api-api-1 python3 /src/manage.py migrate
